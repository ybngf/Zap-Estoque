<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico Servidor - Estoque Gemini</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        .container {
            background: #000;
            padding: 30px;
            border: 2px solid #00ff00;
            border-radius: 10px;
        }
        h1 { color: #00ff00; text-align: center; }
        h2 { color: #ffff00; border-bottom: 1px solid #00ff00; padding-bottom: 5px; }
        button {
            background: #00ff00;
            color: #000;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #00cc00; }
        .result {
            margin-top: 15px;
            padding: 15px;
            border: 1px solid #00ff00;
            border-radius: 5px;
            white-space: pre-wrap;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { background: #003300; color: #00ff00; }
        .error { background: #330000; color: #ff6666; }
        .info { background: #000033; color: #6666ff; }
        .test-item {
            padding: 10px;
            margin: 10px 0;
            background: #111;
            border-left: 3px solid #ffff00;
        }
        .status-ok { color: #00ff00; }
        .status-fail { color: #ff0000; }
        .code {
            background: #222;
            padding: 10px;
            border-left: 3px solid #00ff00;
            margin: 10px 0;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç DIAGN√ìSTICO DO SERVIDOR</h1>
        <p style="text-align: center; color: #ffff00;">Execute estes testes NA ORDEM para identificar o problema</p>

        <h2>1. Teste de Ambiente</h2>
        <button onclick="testEnvironment()">‚ñ∂ Verificar Arquivos e Ambiente</button>
        
        <h2>2. Teste de Conex√£o MySQL</h2>
        <button onclick="testDatabase()">‚ñ∂ Testar Conex√£o do Banco</button>
        
        <h2>3. Teste de Tabelas</h2>
        <button onclick="testTables()">‚ñ∂ Verificar Tabelas</button>
        
        <h2>4. Teste de Dados</h2>
        <button onclick="testUsers()">‚ñ∂ Verificar Usu√°rios</button>
        
        <h2>5. Teste de Login</h2>
        <button onclick="testLogin()">‚ñ∂ Testar Endpoint de Login</button>
        
        <h2>6. Teste Direto SQL</h2>
        <button onclick="testDirectSQL()">‚ñ∂ Simular Query de Login</button>

        <h2>7. Teste de API Health</h2>
        <button onclick="testHealth()">‚ñ∂ Verificar Status da API</button>

        <div id="result"></div>

        <div class="test-item">
            <h3 style="color: #ffff00;">üìã Checklist R√°pido:</h3>
            <div class="code">
# No servidor, execute via SSH:

# 1. Verificar se arquivos existem
ls -la /home/*/public_html/api.php
ls -la /home/*/public_html/.htaccess

# 2. Verificar permiss√µes
chmod 644 /home/*/public_html/api.php
chmod 644 /home/*/public_html/.htaccess

# 3. Ver logs do Apache
tail -f ~/logs/error_log

# 4. Testar MySQL direto
mysql -u dona_estoqueg -p dona_estoqueg -e "SELECT * FROM users;"
            </div>
        </div>
    </div>

    <script>
        const apiBase = window.location.origin;

        function showResult(message, type = 'info') {
            const resultDiv = document.getElementById('result');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = message;
        }

        async function testEnvironment() {
            showResult('üîç Verificando ambiente...', 'info');
            
            const checks = [];
            
            // Check if we're on the right domain
            checks.push(`üåê Dom√≠nio: ${window.location.hostname}`);
            checks.push(`üìç URL Base: ${apiBase}`);
            checks.push(`üîß Protocolo: ${window.location.protocol}`);
            
            // Check if api.php exists
            try {
                const response = await fetch(`${apiBase}/api.php`);
                if (response.ok || response.status === 200) {
                    checks.push(`<span class="status-ok">‚úÖ api.php encontrado</span>`);
                } else {
                    checks.push(`<span class="status-fail">‚ùå api.php n√£o acess√≠vel (${response.status})</span>`);
                }
            } catch (e) {
                checks.push(`<span class="status-fail">‚ùå api.php erro: ${e.message}</span>`);
            }

            // Check .htaccess (indirect)
            try {
                const response = await fetch(`${apiBase}/api/health`);
                if (response.ok) {
                    checks.push(`<span class="status-ok">‚úÖ .htaccess funcionando (rewrite OK)</span>`);
                } else {
                    checks.push(`<span class="status-fail">‚ö†Ô∏è .htaccess pode estar com problema</span>`);
                }
            } catch (e) {
                checks.push(`<span class="status-fail">‚ùå Rewrite n√£o funcionando</span>`);
            }

            showResult(`üìä AMBIENTE:\n\n${checks.join('\n')}`, 'info');
        }

        async function testDatabase() {
            showResult('üîç Testando conex√£o MySQL...', 'info');
            
            try {
                const response = await fetch(`${apiBase}/test-db.php`);
                const data = await response.json();
                
                let result = 'üóÑÔ∏è TESTE DE BANCO:\n\n';
                
                if (data.connection) {
                    result += '<span class="status-ok">‚úÖ CONEX√ÉO: OK</span>\n\n';
                    result += `üìä Tabelas encontradas: ${data.tables.length}\n`;
                    data.tables.forEach(t => result += `   - ${t}\n`);
                    result += `\nüë• Usu√°rios encontrados: ${data.users.length}\n`;
                    
                    if (data.test_login) {
                        if (data.test_login.success) {
                            result += '\n<span class="status-ok">‚úÖ LOGIN TESTE: OK</span>\n';
                            result += `   Usu√°rio: ${data.test_login.user.name}\n`;
                        } else {
                            result += '\n<span class="status-fail">‚ùå LOGIN TESTE: FALHOU</span>\n';
                            result += `   ${data.test_login.message}\n`;
                        }
                    }
                } else {
                    result += '<span class="status-fail">‚ùå CONEX√ÉO: FALHOU</span>\n';
                    result += `Erro: ${data.error}`;
                }
                
                showResult(result, data.connection ? 'success' : 'error');
            } catch (error) {
                showResult(`‚ùå ERRO ao acessar test-db.php:\n\n${error.message}\n\n‚ö†Ô∏è SOLU√á√ÉO:\n1. Certifique-se que test-db.php existe no servidor\n2. Verifique permiss√µes do arquivo (chmod 644)`, 'error');
            }
        }

        async function testTables() {
            showResult('üîç Verificando tabelas necess√°rias...', 'info');
            
            const requiredTables = [
                'companies',
                'users', 
                'categories',
                'suppliers',
                'products',
                'stock_movements'
            ];
            
            try {
                const response = await fetch(`${apiBase}/test-db.php`);
                const data = await response.json();
                
                let result = 'üìä VERIFICA√á√ÉO DE TABELAS:\n\n';
                
                if (data.tables && data.tables.length > 0) {
                    requiredTables.forEach(table => {
                        if (data.tables.includes(table)) {
                            result += `<span class="status-ok">‚úÖ ${table}</span>\n`;
                        } else {
                            result += `<span class="status-fail">‚ùå ${table} - FALTANDO!</span>\n`;
                        }
                    });
                    
                    const missing = requiredTables.filter(t => !data.tables.includes(t));
                    if (missing.length > 0) {
                        result += `\n<span class="status-fail">‚ö†Ô∏è ${missing.length} tabelas faltando!</span>\n`;
                        result += '\nüí° SOLU√á√ÉO:\n';
                        result += '   Execute schema.sql no phpMyAdmin\n';
                    } else {
                        result += '\n<span class="status-ok">‚úÖ Todas as tabelas existem!</span>';
                    }
                } else {
                    result += '<span class="status-fail">‚ùå Nenhuma tabela encontrada!</span>\n\n';
                    result += 'üí° SOLU√á√ÉO:\n';
                    result += '   1. Acesse phpMyAdmin\n';
                    result += '   2. Selecione database "dona_estoqueg"\n';
                    result += '   3. Aba SQL\n';
                    result += '   4. Cole conte√∫do de schema.sql\n';
                    result += '   5. Execute';
                }
                
                showResult(result, data.tables && data.tables.length === 6 ? 'success' : 'error');
            } catch (error) {
                showResult(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        async function testUsers() {
            showResult('üîç Verificando usu√°rios no banco...', 'info');
            
            try {
                const response = await fetch(`${apiBase}/test-db.php`);
                const data = await response.json();
                
                let result = 'üë• USU√ÅRIOS NO BANCO:\n\n';
                
                if (data.users && data.users.length > 0) {
                    result += `<span class="status-ok">‚úÖ ${data.users.length} usu√°rios encontrados:</span>\n\n`;
                    data.users.forEach(user => {
                        result += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                        result += `ID: ${user.id}\n`;
                        result += `Nome: ${user.name}\n`;
                        result += `Email: ${user.email}\n`;
                        result += `Papel: ${user.role}\n`;
                        result += `Empresa: ${user.company}\n`;
                    });
                } else {
                    result += '<span class="status-fail">‚ùå Nenhum usu√°rio encontrado!</span>\n\n';
                    result += 'üí° SOLU√á√ÉO:\n';
                    result += '   Execute a parte de INSERT do schema.sql:\n\n';
                    result += '   INSERT INTO users (name, email, password, role, company, avatar) VALUES\n';
                    result += '   (\'Admin Sistema\', \'admin@sistema.com\', \'123456\', \'Super Admin\', ...);';
                }
                
                showResult(result, data.users && data.users.length > 0 ? 'success' : 'error');
            } catch (error) {
                showResult(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        async function testLogin() {
            showResult('üîç Testando endpoint de login...', 'info');
            
            const credentials = {
                email: 'admin@sistema.com',
                password: '123456'
            };
            
            try {
                const response = await fetch(`${apiBase}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(credentials)
                });
                
                const data = await response.json();
                
                let result = 'üîê TESTE DE LOGIN:\n\n';
                result += `Email: ${credentials.email}\n`;
                result += `Senha: ${credentials.password}\n`;
                result += `Status: ${response.status}\n\n`;
                
                if (response.ok) {
                    result += '<span class="status-ok">‚úÖ LOGIN SUCESSO!</span>\n\n';
                    result += `Usu√°rio autenticado:\n`;
                    result += `ID: ${data.id}\n`;
                    result += `Nome: ${data.name}\n`;
                    result += `Email: ${data.email}\n`;
                    result += `Papel: ${data.role}\n`;
                    result += `Empresa: ${data.company}\n`;
                } else {
                    result += '<span class="status-fail">‚ùå LOGIN FALHOU!</span>\n\n';
                    result += `Resposta: ${JSON.stringify(data, null, 2)}\n\n`;
                    result += 'üîç DIAGN√ìSTICO:\n\n';
                    
                    if (response.status === 401) {
                        result += '‚ùå Status 401 = Credenciais inv√°lidas\n\n';
                        result += 'POSS√çVEIS CAUSAS:\n';
                        result += '1. Senha no banco est√° diferente de "123456"\n';
                        result += '2. Email n√£o existe\n';
                        result += '3. Tabela users vazia\n';
                        result += '4. Query SQL incorreta no api.php\n\n';
                        result += 'üí° PR√ìXIMO TESTE:\n';
                        result += 'Execute "Teste Direto SQL" abaixo\n';
                    } else if (response.status === 404) {
                        result += '‚ùå Status 404 = Endpoint n√£o encontrado\n\n';
                        result += 'POSS√çVEIS CAUSAS:\n';
                        result += '1. .htaccess n√£o est√° funcionando\n';
                        result += '2. Rota /auth/login n√£o existe no api.php\n';
                        result += '3. Arquivo api.php com erro\n';
                    } else if (response.status === 500) {
                        result += '‚ùå Status 500 = Erro interno\n\n';
                        result += 'POSS√çVEIS CAUSAS:\n';
                        result += '1. Erro de sintaxe no api.php\n';
                        result += '2. Banco de dados n√£o conectado\n';
                        result += '3. Tabela n√£o existe\n\n';
                        result += 'üí° SOLU√á√ÉO:\n';
                        result += 'Via SSH: tail -f ~/logs/error_log\n';
                    }
                }
                
                showResult(result, response.ok ? 'success' : 'error');
            } catch (error) {
                showResult(`‚ùå ERRO ao chamar API:\n\n${error.message}\n\nüîç POSS√çVEIS CAUSAS:\n1. api.php n√£o existe\n2. .htaccess n√£o configurado\n3. Erro CORS\n4. Apache n√£o est√° rodando`, 'error');
            }
        }

        async function testDirectSQL() {
            showResult('üîç Testando query SQL direta...', 'info');
            
            try {
                const response = await fetch(`${apiBase}/test-db.php`);
                const data = await response.json();
                
                let result = 'üóÑÔ∏è TESTE DE QUERY SQL:\n\n';
                result += 'Query executada:\n';
                result += 'SELECT * FROM users WHERE email = "admin@sistema.com" AND password = "123456"\n\n';
                
                if (data.test_login) {
                    if (data.test_login.success) {
                        result += '<span class="status-ok">‚úÖ QUERY RETORNOU DADOS!</span>\n\n';
                        result += `Usu√°rio encontrado:\n`;
                        result += `ID: ${data.test_login.user.id}\n`;
                        result += `Nome: ${data.test_login.user.name}\n`;
                        result += `Email: ${data.test_login.user.email}\n\n`;
                        result += '‚úÖ O BANCO EST√Å OK!\n\n';
                        result += 'üîç CONCLUS√ÉO:\n';
                        result += 'Se este teste passou mas o login falha,\n';
                        result += 'o problema est√° em api.php linha 100-115\n';
                        result += '(fun√ß√£o handleAuth)\n\n';
                        result += 'üí° VERIFIQUE:\n';
                        result += '1. Se api.php est√° recebendo os dados POST\n';
                        result += '2. Se a query est√° usando os par√¢metros corretos\n';
                        result += '3. Logs do PHP: tail -f ~/logs/error_log';
                    } else {
                        result += '<span class="status-fail">‚ùå QUERY N√ÉO RETORNOU DADOS!</span>\n\n';
                        result += `Mensagem: ${data.test_login.message}\n\n`;
                        result += 'üîç DIAGN√ìSTICO:\n';
                        result += 'Usu√°rio admin@sistema.com n√£o existe OU\n';
                        result += 'Senha n√£o √© "123456" (pode estar com hash)\n\n';
                        result += 'üí° SOLU√á√ÉO:\n';
                        result += 'Execute no phpMyAdmin:\n\n';
                        result += 'SELECT email, password FROM users;\n\n';
                        result += 'Verifique se a senha est√° em texto puro';
                    }
                } else {
                    result += '‚ö†Ô∏è Teste n√£o dispon√≠vel';
                }
                
                showResult(result, data.test_login && data.test_login.success ? 'success' : 'error');
            } catch (error) {
                showResult(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        async function testHealth() {
            showResult('üîç Testando sa√∫de da API...', 'info');
            
            try {
                const response = await fetch(`${apiBase}/api/health`);
                const data = await response.json();
                
                if (response.ok) {
                    showResult(`‚úÖ API EST√Å ONLINE!\n\nResposta: ${JSON.stringify(data, null, 2)}\n\nüéØ A API est√° funcionando!\nSe o login falha, o problema √© espec√≠fico na autentica√ß√£o.`, 'success');
                } else {
                    showResult(`‚ö†Ô∏è API respondeu mas com erro:\n${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå API N√ÉO RESPONDE:\n\n${error.message}\n\nüí° SOLU√á√ïES:\n1. Verifique se api.php existe\n2. Verifique .htaccess\n3. Verifique permiss√µes (chmod 644)\n4. Veja logs: tail -f ~/logs/error_log`, 'error');
            }
        }

        // Auto-run health check
        window.onload = () => {
            setTimeout(() => {
                testHealth();
            }, 1000);
        };
    </script>
</body>
</html>
