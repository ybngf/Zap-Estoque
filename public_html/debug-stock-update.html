<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Atualiza√ß√£o de Estoque</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #059669;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #047857;
        }
        .error {
            background: #fee;
            color: #c00;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background: #efe;
            color: #060;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .warning {
            background: #ffc;
            color: #660;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background: #f0f0f0;
        }
    </style>
</head>
<body>
    <h1>üîç Debug - Atualiza√ß√£o de Estoque</h1>
    
    <div class="test-section">
        <h2>1. Verificar Produto no Banco (ANTES)</h2>
        <button onclick="checkProductBefore()">Verificar Produto ID 1</button>
        <div id="beforeResult"></div>
    </div>

    <div class="test-section">
        <h2>2. Fazer Update do Estoque</h2>
        <p>Vamos atualizar o estoque de 1 produto para um valor espec√≠fico</p>
        <button onclick="doUpdate()">Atualizar Stock para 999</button>
        <div id="updateResult"></div>
    </div>

    <div class="test-section">
        <h2>3. Verificar Produto no Banco (DEPOIS)</h2>
        <button onclick="checkProductAfter()">Re-verificar Produto ID 1</button>
        <div id="afterResult"></div>
    </div>

    <div class="test-section">
        <h2>4. Verificar √öltima Movimenta√ß√£o</h2>
        <button onclick="checkLastMovement()">Ver √öltima Movimenta√ß√£o</button>
        <div id="movementResult"></div>
    </div>

    <div class="test-section">
        <h2>5. Verificar Usu√°rios</h2>
        <button onclick="checkUsers()">Listar Todos Usu√°rios</button>
        <div id="usersResult"></div>
    </div>

    <script>
        const API_URL = '/EstoqueGemini/api';
        let productBefore = null;

        async function checkProductBefore() {
            const result = document.getElementById('beforeResult');
            result.innerHTML = '‚è≥ Verificando produto...';
            
            try {
                const response = await fetch(`${API_URL}/products/1`);
                if (!response.ok) throw new Error('Erro ao buscar produto');
                
                productBefore = await response.json();
                
                result.innerHTML = `
                    <div class="success">‚úÖ Produto encontrado!</div>
                    <table>
                        <tr><th>Campo</th><th>Valor</th></tr>
                        <tr><td>ID</td><td>${productBefore.id}</td></tr>
                        <tr><td>Name</td><td>${productBefore.name}</td></tr>
                        <tr><td><strong>Stock (ANTES)</strong></td><td><strong style="color: blue; font-size: 18px;">${productBefore.stock}</strong></td></tr>
                        <tr><td>Category ID</td><td>${productBefore.categoryId}</td></tr>
                        <tr><td>Supplier ID</td><td>${productBefore.supplierId}</td></tr>
                    </table>
                `;
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
            }
        }

        async function doUpdate() {
            const result = document.getElementById('updateResult');
            result.innerHTML = '‚è≥ Atualizando estoque...';
            
            try {
                console.log('üì§ Enviando PUT /products/1 com body:', { stock: 999 });
                
                const response = await fetch(`${API_URL}/products/1`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stock: 999 })
                });

                console.log('üì• Status da resposta:', response.status);
                
                const responseText = await response.text();
                console.log('üì• Resposta bruta:', responseText);
                
                if (!response.ok) {
                    throw new Error('Erro na atualiza√ß√£o: ' + responseText);
                }

                const updatedProduct = JSON.parse(responseText);
                console.log('üì• Produto atualizado (JSON):', updatedProduct);
                
                result.innerHTML = `
                    <div class="success">
                        <h3>‚úÖ PUT realizado com sucesso!</h3>
                        <p><strong>Stock retornado pela API:</strong> ${updatedProduct.stock}</p>
                    </div>
                    <pre>${JSON.stringify(updatedProduct, null, 2)}</pre>
                    <div class="warning">
                        ‚ö†Ô∏è IMPORTANTE: Agora clique no bot√£o "Re-verificar Produto" acima para confirmar se o valor foi salvo no banco de dados!
                    </div>
                `;
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
                console.error('Erro:', error);
            }
        }

        async function checkProductAfter() {
            const result = document.getElementById('afterResult');
            result.innerHTML = '‚è≥ Re-verificando produto no banco...';
            
            try {
                // For√ßar busca nova (sem cache)
                const response = await fetch(`${API_URL}/products/1?_=${Date.now()}`);
                if (!response.ok) throw new Error('Erro ao buscar produto');
                
                const productAfter = await response.json();
                
                const stockChanged = productBefore && productBefore.stock !== productAfter.stock;
                
                result.innerHTML = `
                    <div class="${stockChanged ? 'success' : 'error'}">
                        ${stockChanged ? '‚úÖ ESTOQUE FOI ATUALIZADO NO BANCO!' : '‚ùå ESTOQUE N√ÉO MUDOU NO BANCO!'}
                    </div>
                    <table>
                        <tr><th>Campo</th><th>Valor ANTES</th><th>Valor DEPOIS</th><th>Status</th></tr>
                        <tr>
                            <td><strong>Stock</strong></td>
                            <td style="color: blue; font-size: 16px;">${productBefore ? productBefore.stock : 'N/A'}</td>
                            <td style="color: ${stockChanged ? 'green' : 'red'}; font-size: 16px;"><strong>${productAfter.stock}</strong></td>
                            <td>${stockChanged ? '‚úÖ Mudou' : '‚ùå N√£o mudou'}</td>
                        </tr>
                    </table>
                    <pre>${JSON.stringify(productAfter, null, 2)}</pre>
                `;
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
            }
        }

        async function checkLastMovement() {
            const result = document.getElementById('movementResult');
            result.innerHTML = '‚è≥ Buscando √∫ltima movimenta√ß√£o...';
            
            try {
                const response = await fetch(`${API_URL}/stock-movements`);
                if (!response.ok) throw new Error('Erro ao buscar movimenta√ß√µes');
                
                const movements = await response.json();
                
                if (movements.length === 0) {
                    result.innerHTML = '<div class="warning">‚ö†Ô∏è Nenhuma movimenta√ß√£o encontrada</div>';
                    return;
                }
                
                // Pegar a √∫ltima
                const last = movements[0];
                
                result.innerHTML = `
                    <div class="success">‚úÖ √öltima movimenta√ß√£o encontrada!</div>
                    <table>
                        <tr><th>Campo</th><th>Valor</th></tr>
                        <tr><td>ID</td><td>${last.id}</td></tr>
                        <tr><td>Product ID</td><td>${last.productId}</td></tr>
                        <tr><td><strong>User ID</strong></td><td><strong style="color: ${last.userId ? 'green' : 'red'};">${last.userId || 'NULL/VAZIO!'}</strong></td></tr>
                        <tr><td>Type</td><td>${last.type}</td></tr>
                        <tr><td>Quantity</td><td>${last.quantity}</td></tr>
                        <tr><td>Reason</td><td>${last.reason}</td></tr>
                        <tr><td>Date</td><td>${last.date}</td></tr>
                    </table>
                    <pre>${JSON.stringify(last, null, 2)}</pre>
                `;
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
            }
        }

        async function checkUsers() {
            const result = document.getElementById('usersResult');
            result.innerHTML = '‚è≥ Buscando usu√°rios...';
            
            try {
                const response = await fetch(`${API_URL}/users`);
                if (!response.ok) throw new Error('Erro ao buscar usu√°rios');
                
                const users = await response.json();
                
                result.innerHTML = `
                    <div class="success">‚úÖ ${users.length} usu√°rio(s) encontrado(s)</div>
                    <table>
                        <tr><th>ID</th><th>Nome</th><th>Email</th><th>Role</th></tr>
                        ${users.map(u => `
                            <tr>
                                <td>${u.id}</td>
                                <td>${u.name}</td>
                                <td>${u.email}</td>
                                <td>${u.role}</td>
                            </tr>
                        `).join('')}
                    </table>
                    <pre>${JSON.stringify(users, null, 2)}</pre>
                `;
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
            }
        }

        // Carregar produto automaticamente
        window.onload = () => {
            checkProductBefore();
        };
    </script>
</body>
</html>
